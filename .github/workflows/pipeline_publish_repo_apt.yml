name: Publish-to-APT
on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Get GPG private key from AWS Secrets Manager
      uses: action-factory/aws-secrets-manager-action@v0.2.0
      with:
        aws_access_key_id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws_secret_access_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws_region: ${{ secrets.AWS_REGION }}
        # Secret will be converted to env var
        secrets: gpg_private_key
        parse_json: false

    - name: Push APT_NEW_DEB_PACKAGE to APT repo in S3
      run: |
        docker run -i --privileged \
        -e AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }} \
        -e AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }} \
        -e AWS_STORAGE_BUCKET_NAME='nr-repo-apt' \
        -e AWS_S3_MOUNTPOINT='/mnt/aptly' \
        -e APTLY_REPO_NAME='bionic-main' \
        -e APT_NEW_DEB_PACKAGE='' \
        -e GPG_PRIVATE_KEY='-----BEGIN PGP PRIVATE KEY BLOCK-----lQHYBF65UyUBBADy6JQXskmFUesSxDZm3Pql5BdJpv2w/gWcUqZGNjoT9jeOwjD+9UYbZP30j5M6tLKJkW2RgbrSV5Ea/Yuypa7zwmgXWPCL0vKgAyU2FDGvI1Y4dswcib2WfvxLWwE0cEMmL5D8DELjaMSpKMb/Sgav6/rWzmVr0mfd4guNfnyCewARAQABAAP+IxV35kry7Crzx/HHuxL/BMeCnDmz+e9b7MMnOYw1gT1BCFaAmyKJQ1r9LxMu/FNYV3RGHguzFGm0ufBAUBzhaBL1ke4HIhskBHEwNUlQNIc3kkx7W87+HtNcirRSqPEUpwl6SH/8SJt4qin9E1N5437r0qTBMap9oz60VJC4lAECAPkzwIa6KwYD06icsv4b5oTE+OBTwcR0ecMLRUXG6IEkpXBtIK9JBOgHQG2AyHyWAPyl7rL29b8GthUd2fBhzgECAPmI4EsVljmo6nw/+3V+92Vh3pNVSYiNn1cJB24ItO4hJCGzqlUH2C5TeWjjbYSTKFh01zcjm2XALlz7dcYOiHsB/3rInxhPmJor3cJIi4/Ifnt2Tuxrn2K+TKS0OMNziNKS8yb8SMaQjV1q5SMjtOukDwxIKA14vq7Pvl8ZIntwicOfg7QYbmV3cmVsaWMtam9hbiA8cHBAcHAuZXM+iM4EEwEIADgWIQS868jcpQ8M/fy9+nqknf22h2EWDQUCXrlTJQIbAwULCQgHAgYVCAkKCwIEFgIDAQIeAQIXgAAKCRCknf22h2EWDRsKA/95QnjpB3lgUiffJvPFh7K/E3Kp2j7LYyoc3HfqJgzh3CosR/q6DIUV8vhe/rv36nqHSfa8b7Ry4MSvttWTvag2gB7zAbiKuR56vUvx2eNSuORGoRdB84ObtF3zPXme4aqRiBUzcsbkPIOfi2kMgHbvVRaFF4N4ZVXHqlFl/7Vgfp0B2AReuVMlAQQAxZUY8WndJO+P5E/Hn4oVoHT4CM0dk9vBmaf6VP/Gr9VbTe4yB+6ARYvKFUY3Gcg3638ZIve+aY3stFl0+OY2KALM/vW0tbZmDaXnfmQ2Sm5/Ijo5UMyg/F8agw0mnqCtnD0xW+uFsflpA0J5R67nSGnfUzOfRuhXIG2J8vLQqdsAEQEAAQAD/0rSAq+MwL83brxtD7GVF0p7cN/YWL6Apegbibr9Xs6AE4LH1C9XvEBZxs1WmRAM10w5BZpNyc/r/Dpxc8+7Ub8bs/PgLx/qhbOoaYGEHKtvIxvKMCxJ+SDumbf1RlmqUrerjzMa1Mnze+9/IHSVKseJP54u9MGsgMPyanE0MT0NAgDeVwco4Y5RaqMqcL8jxMnnmaWOYK+joEcG3n8HGGFY3kkuQWyC5/dKhe1ZNzxSvJct6v8E948BnLGzPTqA5k1nAgDjfpHzV5dMajyNXpmFtW2HNJiGUcxn0uTZc+H+WM8u+htza4FyfS0nhpKwh4v1qj/Ojcuh9yJwsN2YQAFx6oNtAgCjTyk45nbj2MTR9CON+1n87VBk0+WBnHs+Bhae6ODvkRTe09yJp6YAJd3jfxPgADfm2mqwQxryK7H9v0iTlUpNqTSItgQYAQgAIBYhBLzryNylDwz9/L36eqSd/baHYRYNBQJeuVMlAhsMAAoJEKSd/baHYRYNlukD/01t2mLWJnZZJ/KxB8sktXtYnMTnQQk6HVLuH/MAT+Q0riMP9/X0JREqyXlS4crub0LdmCwTgLPSfTSX6Vc+b6Up1C42y5O+xlQ56Y/O43HE5LI8pPpY41wE1AGBeL0wo2PC1oTIRVOYADyczk2jNqf9Ux3yeOxeG3mw/xpHZqYb=oAar-----END PGP PRIVATE KEY BLOCK-----' \
        jportasa/aptly-s3fuse:1.0 \
        bash -c """ \
             echo $GPG_PRIVATE_KEY > gpg_private_key.gpg; \
             cat gpg_private_key.gpg; \
             gpg --allow-secret-key-import gpg_private_key.gpg; \
             gpg --list-keys
        """
#             gpg --allow-secret-key-import gpg_private_key.gpg; \
#             gpg --list-keys
#             && apt-get update \
#             && apt install wget -y \
#             && wget -qO https://download.newrelic.com/infrastructure_agent/linux/apt/pool/main/n/nri-haproxy/nri-haproxy_0.1.0-1_amd64.deb \
#             && aptly repo add ${APTLY_REPO_NAME} ./nri-haproxy_0.1.0-1_amd64.deb \
#             && aptly publish repo $APTLY_REPO_NAME s3:${AWS_APTLY_FRONTEND_STORAGE_NAME}:
#        """







